<div class="lobby-container">
  <div class="card lobby-card">
    <h1>üêç Snake Game - Multiplayer</h1>

    <div *ngIf="!isConnected" class="connect-section">
      <div *ngIf="errorMessage" class="error-message">
        <p>{{ errorMessage }}</p>
        <p class="error-hint">Please choose a different username.</p>
      </div>
      <div class="input-group">
        <input
          type="text"
          [(ngModel)]="username"
          placeholder="Enter your username"
          (keyup.enter)="connect()"
        />
      </div>
      <div class="button-container">
        <button class="btn-primary" (click)="connect()">Connect</button>
      </div>
    </div>

    <div *ngIf="isConnected && showUsernameEdit" class="username-edit-section">
      <h3>Update Username</h3>
      <div class="input-group">
        <input
          type="text"
          [(ngModel)]="username"
          placeholder="Enter new username"
          (keyup.enter)="updateUsername()"
        />
        <button class="btn-success" (click)="updateUsername()">Update</button>
        <button class="btn-danger" (click)="cancelEditUsername()">Cancel</button>
      </div>
    </div>

    <div *ngIf="isConnected" class="lobby-content-wrapper">
      <div class="header-section">
        <div class="header-title">
          <h2>Lobby</h2>
          <p class="username">
            Welcome, <strong>{{ currentPlayer?.username }}</strong>
          </p>
        </div>
        <div class="header-actions">
          <button class="btn-secondary btn-outline" (click)="editUsername()" title="Change username">
            ‚úèÔ∏è Edit
          </button>
          <button class="btn-danger" (click)="disconnect()">Disconnect</button>
        </div>
      </div>

      <!-- Game Requests (Multiple) -->
      <div *ngIf="gameRequests.length > 0" class="game-requests-section">
        <h3>Game Requests ({{ gameRequests.length }})</h3>
        <div class="requests-list">
          <div *ngFor="let request of gameRequests" class="request-item">
            <div class="request-info">
              <span class="request-from">{{ request.from_player?.username }}</span>
              <span class="request-text">wants to play with you</span>
            </div>
            <div class="request-actions">
              <button class="btn-success" (click)="acceptGameRequest(request.game_id)">
                Accept
              </button>
              <button class="btn-danger" (click)="rejectGameRequest(request.game_id)">
                Reject
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Pending Requests (Multiple) -->
      <div *ngIf="pendingRequests.length > 0" class="pending-requests-section">
        <h3>Pending Requests ({{ pendingRequests.length }})</h3>
        <div class="pending-list">
          <div *ngFor="let request of pendingRequests" class="pending-item">
            <div class="pending-info">
              <span class="pending-text">Waiting for</span>
              <span class="pending-to">{{ request.to_player?.username }}</span>
              <span class="pending-text">to respond...</span>
            </div>
            <button class="btn-cancel" (click)="cancelGameRequest(request.to_player?.id)">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div class="players-section">
        <h3>Players ({{ players.length }})</h3>
        <div class="players-list">
          <div
            *ngFor="let player of players"
            class="player-item"
            [class.current-player]="isCurrentPlayer(player.id)"
          >
            <div class="player-info">
              <span class="player-name">{{ player.username }}</span>
              <span *ngIf="isCurrentPlayer(player.id)" class="you-badge">You</span>
            </div>
            <div *ngIf="!isCurrentPlayer(player.id)" class="player-actions">
              <button
                *ngIf="!hasPendingRequestTo(player.id)"
                class="btn-secondary btn-small"
                (click)="sendGameRequest(player.id)"
              >
                Send Request
              </button>
              <div *ngIf="hasPendingRequestTo(player.id)" class="request-status">
                <span class="status-text">Request sent</span>
                <button
                  class="btn-cancel-small"
                  (click)="cancelGameRequest(player.id)"
                  title="Cancel request"
                >
                  ‚úï
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="active-games-section">
        <h3>Active Games ({{ activeGames.length }})</h3>
        <div class="games-list">
          <div *ngFor="let game of activeGames" class="game-item">
            <div class="game-info">
              <div class="game-players">
                <span class="player-name">{{ game.player1 }}</span>
                <span class="vs">vs</span>
                <span class="player-name">{{ game.player2 }}</span>
              </div>
              <div class="game-status">
                <span class="status-badge" [class.playing]="game.status === 'playing'" 
                      [class.waiting]="game.status === 'waiting'"
                      [class.finished]="game.status === 'finished'">
                  {{ game.status }}
                </span>
                <span *ngIf="game.spectators > 0" class="spectators-count">
                  üëÅÔ∏è {{ game.spectators }}
                </span>
              </div>
              <div *ngIf="game.scores" class="game-scores">
                <span>{{ game.player1 }}: {{ game.scores[game.player1] }}</span>
                <span>{{ game.player2 }}: {{ game.scores[game.player2] }}</span>
              </div>
            </div>
            <button
              class="btn-secondary"
              (click)="watchGame(game.id)"
              [disabled]="game.status === 'finished'"
            >
              Watch
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

