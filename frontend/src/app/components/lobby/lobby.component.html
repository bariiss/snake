<div class="lobby-container">
  <div class="card lobby-card">
    <h1>üêç Slither Arena</h1>

    <div *ngIf="!isConnected" class="connect-section">
      <div *ngIf="errorMessage" class="error-message">
        <p>{{ errorMessage }}</p>
        <p class="error-hint">Please choose a different nickname.</p>
      </div>
      <p class="connect-subtitle">Enter your nickname to join the arena</p>
      <div class="input-group">
        <span class="input-icon">üë§</span>
        <input
          type="text"
          [(ngModel)]="username"
          placeholder="Nickname"
          (keyup.enter)="connect()"
        />
      </div>
      <div class="button-container">
        <button class="btn-primary" (click)="connect()">Connect</button>
      </div>
    </div>

    <!-- Username Edit Modal -->
    <div *ngIf="showUsernameEdit" class="modal-overlay" (click)="cancelEditUsername()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Update Nickname</h3>
          <button class="btn-close-modal" (click)="cancelEditUsername()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <span class="input-icon">üë§</span>
            <input
              type="text"
              [(ngModel)]="editUsernameValue"
              placeholder="Enter new nickname"
              (keyup.enter)="updateUsername()"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-success btn-small" (click)="updateUsername()">Update</button>
          <button class="btn-danger btn-small" (click)="cancelEditUsername()">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Mode Selection Screen -->
    <div *ngIf="isConnected && showModeSelection" class="mode-selection-section">
      <h2>Choose Game Mode</h2>
      <p class="mode-subtitle">How would you like to play?</p>
      <div class="mode-buttons">
        <button class="mode-button single-player" (click)="selectSinglePlayer()">
          <div class="mode-icon">üéÆ</div>
          <div class="mode-title">Single Player</div>
          <div class="mode-description">Play alone and try to beat your high score</div>
        </button>
        <button class="mode-button multiplayer" (click)="selectMultiplayer()">
          <div class="mode-icon">üë•</div>
          <div class="mode-title">Multiplayer</div>
          <div class="mode-description">Challenge other players in the lobby</div>
        </button>
      </div>
    </div>

    <div *ngIf="isConnected && !showModeSelection" class="lobby-content-wrapper">
      <div class="header-section">
        <div class="header-title">
          <h2>Lobby</h2>
          <p class="username">
            Welcome, <strong>{{ currentPlayer?.username }}</strong>
          </p>
        </div>
        <div class="header-actions">
          <button class="btn-secondary btn-outline" (click)="editUsername()" title="Change nickname">
            ‚úèÔ∏è Edit
          </button>
          <button class="btn-danger" (click)="disconnect()">Disconnect</button>
        </div>
      </div>

      <!-- Two Column Layout -->
      <div class="lobby-main-content">
        <!-- Left Column: Players List -->
        <div class="lobby-left-column">
          <div class="players-section">
            <h3>Players ({{ players.length }})</h3>
            <div class="players-list">
              <div
                *ngFor="let player of players"
                class="player-item"
                [class.current-player]="isCurrentPlayer(player.id)"
              >
                <div class="player-info">
                  <span class="player-name">{{ player.username }}</span>
                  <span *ngIf="isCurrentPlayer(player.id)" class="you-badge">You</span>
                  <span *ngIf="!isCurrentPlayer(player.id) && player.in_game" class="in-game-badge">In Game</span>
                </div>
                <div *ngIf="!isCurrentPlayer(player.id) && !player.in_game" class="player-actions">
                  <button
                    *ngIf="!hasPendingRequestTo(player.id) && !hasGameRequestFrom(player.id)"
                    class="btn-secondary btn-small"
                    (click)="sendGameRequest(player.id)"
                    title="Send game request"
                  >
                    Request
                  </button>
                  <div *ngIf="hasPendingRequestTo(player.id)" class="request-status">
                    <span class="status-text">Request sent</span>
                    <button
                      class="btn-cancel-small"
                      (click)="cancelGameRequest(player.id)"
                      title="Cancel request"
                    >
                      ‚úï
                    </button>
                  </div>
                  <div *ngIf="hasGameRequestFrom(player.id)" class="request-status incoming">
                    <span class="status-text">Waiting for {{ getGameRequestFrom(player.id)?.from_player?.username }} to respond...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Requests and Info -->
        <div class="lobby-right-column">
          <!-- Game Requests (Multiple) - Prominent -->
          <div *ngIf="gameRequests.length > 0" class="game-requests-section prominent">
            <div class="section-header">
              <h3>üéÆ Game Requests ({{ gameRequests.length }})</h3>
            </div>
            <div class="requests-list">
              <div *ngFor="let request of gameRequests" class="request-item prominent-request">
                <div class="request-content">
                  <div class="request-info">
                    <span class="request-from">{{ request.from_player?.username }}</span>
                    <span class="request-text">wants to play with you!</span>
                  </div>
                  <div class="request-actions">
                    <button class="btn-success btn-large" (click)="acceptGameRequest(request.game_id)">
                      ‚úì Accept
                    </button>
                    <button class="btn-danger btn-large" (click)="rejectGameRequest(request.game_id)">
                      ‚úï Reject
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Requests (Multiple) -->
          <div *ngIf="pendingRequests.length > 0" class="pending-requests-section">
            <h3>Pending Requests ({{ pendingRequests.length }})</h3>
            <div class="pending-list">
              <div *ngFor="let request of pendingRequests" class="pending-item">
                <div class="pending-info">
                  <span class="pending-text">Waiting for</span>
                  <span class="pending-to">{{ request.to_player?.username }}</span>
                  <span class="pending-text">to respond...</span>
                </div>
                <button class="btn-cancel" (click)="cancelGameRequest(request.to_player?.id)">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Active Games -->
          <div class="active-games-section">
            <h3>Active Games ({{ activeGames.length }})</h3>
            <div class="games-list">
              <div *ngFor="let game of activeGames" class="game-item">
                <div class="game-info">
                  <div class="game-players">
                    <span class="player-name">{{ game.player1 }}</span>
                    <span class="vs">vs</span>
                    <span class="player-name">{{ game.player2 }}</span>
                  </div>
                  <div class="game-status">
                    <span class="status-badge" [class.playing]="game.status === 'playing'" 
                          [class.waiting]="game.status === 'waiting'"
                          [class.finished]="game.status === 'finished'">
                      {{ game.status }}
                    </span>
                    <span *ngIf="game.spectators > 0" class="spectators-count">
                      üëÅÔ∏è {{ game.spectators }}
                    </span>
                  </div>
                  <div *ngIf="game.scores" class="game-scores">
                    <span>{{ game.player1 }}: {{ game.scores[game.player1] }}</span>
                    <span>{{ game.player2 }}: {{ game.scores[game.player2] }}</span>
                  </div>
                </div>
                <button
                  *ngIf="game.status !== 'finished'"
                  class="btn-secondary"
                  (click)="watchGame(game.id)"
                >
                  Watch
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

