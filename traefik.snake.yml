http:
  routers:
    # Backend router for WebSocket
    snake-backend-ws-router:
      rule: "Host(`snake.li1.nl`) && PathPrefix(`/ws`)"
      entryPoints:
        - websecure
      service: snake-backend-service
      tls:
        certResolver: cloudflare
      middlewares:
        - websocket-headers

    # Backend router for WebRTC peer signaling
    snake-backend-webrtc-router:
      rule: "Host(`snake.li1.nl`) && PathPrefix(`/webrtc/peer/`)"
      entryPoints:
        - websecure
      service: snake-backend-service
      tls:
        certResolver: cloudflare
      middlewares:
        - cors-headers

    # Frontend router (must be last, lowest priority)
    snake-frontend-router:
      rule: "Host(`snake.li1.nl`)"
      entryPoints:
        - websecure
      service: snake-frontend-service
      tls:
        certResolver: cloudflare
      priority: 1

  middlewares:
    # WebSocket headers middleware
    websocket-headers:
      headers:
        customRequestHeaders:
          Upgrade: "websocket"
          Connection: "Upgrade"

    # CORS headers for WebRTC endpoints
    cors-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - OPTIONS
        accessControlAllowHeaders:
          - Content-Type
          - Authorization
        accessControlAllowOrigin: "*"
        accessControlMaxAge: 3600
        addVaryHeader: true

  services:
    snake-frontend-service:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:8040"

    snake-backend-service:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:8020"

